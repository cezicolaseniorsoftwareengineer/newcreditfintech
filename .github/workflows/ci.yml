name: CI/CD Pipeline

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]

env:
    PYTHON_VERSION: "3.11"
    DOCKER_IMAGE: newcredit-fintech

jobs:
    quality-assurance:
        name: Quality Assurance
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python ${{ env.PYTHON_VERSION }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: "pip"

            - name: Install Dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install flake8 bandit safety pytest pytest-cov httpx
                  if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

            - name: Linting (Flake8)
              run: |
                  # Stop the build if there are Python syntax errors or undefined names
                  flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
                  # Enforce style guide (PEP 8)
                  flake8 . --count --max-complexity=10 --max-line-length=127 --statistics

            - name: Security Scan (Bandit)
              run: |
                  bandit -r app -f custom --msg-template "{abspath}:{line}: {test_id}[{severity}]: {msg}"

            - name: Dependency Audit (Safety)
              run: |
                  # Check for known vulnerabilities in dependencies
                  safety check --ignore=70612

            - name: Run Tests (Pytest)
              run: |
                  pytest --cov=app --cov-report=term-missing --cov-fail-under=80

    build-and-validate:
        name: Build & Validate
        runs-on: ubuntu-latest
        needs: quality-assurance
        steps:
            - uses: actions/checkout@v4

            - name: Build Docker Image
              run: docker build . --file Dockerfile --tag ${{ env.DOCKER_IMAGE }}:latest

            - name: Smoke Test
              run: |
                  docker run -d --name app_container -p 8000:8000 ${{ env.DOCKER_IMAGE }}:latest
                  sleep 10
                  if [ "$(docker inspect -f '{{.State.Running}}' app_container)" = "true" ]; then
                      echo "Container is running."
                  else
                      echo "Container failed to start."
                      docker logs app_container
                      exit 1
                  fi
                  curl --fail http://localhost:8000/health || (docker logs app_container && exit 1)
